import akka.actor.ActorSystem
import akka.testkit.{ImplicitSender, TestActors, TestKit}
import akka.util.ByteString
import org.esipeng.akka.io.diameter.{DiameterMessage, DiameterMessageBuffer}
import org.scalatest.{BeforeAndAfterAll, Matchers, WordSpecLike}
/**
  * Created by stiff on 2016/4/15.
  */
class DiameterMessageBufferActorTest extends TestKit(ActorSystem("Spec")) with ImplicitSender
 with WordSpecLike with Matchers with BeforeAndAfterAll {
  override def afterAll: Unit = {
    TestKit.shutdownActorSystem(system)
  }

  "Message Buffer " must {
    "decode single and fragment message" in {
      val mySelf = self
      val buffer = system.actorOf(DiameterMessageBuffer.props(mySelf))

      val requestRaw = ByteString(HexUtil.hexStringToByte("01000174c000012d01000000e58881ab9f80c00b0000010740000025616263646566672e746573742e636c69656e742e73657373696f6e696400000000000104400000200000010a4000000c000028af000001024000000c01000000000001154000000c0000000100000128400000146572696373736f6e2e636f6d000001084000001d4f726967696e31302e6572696373736f6e2e636f6d00000000000125400000176873732e6572696373736f6e2e7365000000011b400000136572696373736f6e2e7365000000027480000038000028af0000010a4000000c000028af0000027580000010000028af000000010000027680000010000028af0000000500000259c0000030000028af7369703a557365724e616d65355f305075626c6963494430406572696373736f6e2e73650000025ac0000021000028af4f726967696e31302e6572696373736f6e2e636f6d00000000000266c0000010000028af0000000300000270c0000010000028af00000000"))
      buffer ! requestRaw
      val returnedMsg = expectMsgAnyClassOf(classOf[DiameterMessage])
      assert(returnedMsg.header.applicationId==16777216)
      assert(returnedMsg.header.request)
      assert(returnedMsg.header.proxyable)
      assert(returnedMsg.header.error == false)
      assert(returnedMsg.header.retransmission == false)
      assert(returnedMsg.header.commandCode == 301)
      assert( returnedMsg.header.h2h == 0xe58881ab)
      assert( returnedMsg.header.e2e == 0x9f80c00b)
      assert(returnedMsg.avps.size == 12)


      val requestFragments = Array(
        ByteString(HexUtil.hexStringToByte("01002ef84000012d01000000e58881ab9f80c00b0000010740000025616263646566672e746573742e636c69656e742e73657373696f6e696400000000000128400000136572696373736f6e2e73650000000108400000176873732e6572696373736f6e2e73650000000104400000200000010a4000000c000028af000001024000000c01000000000001154000000c000000010000010c4000000c000007d10000025ec0002d12000028af3c3f786d6c2076657273696f6e3d22312e302220656e636f64696e673d225554462d38223f3e3c494d53537562736372697074696f6e20786d6c6e733a7873693d27687474703a2f2f7777772e77332e6f72672f323030312f584d4c536368656d612d696e7374616e636527207873693a6e6f4e616d657370616365536368656d614c6f636174696f6e3d2743784461746154797065334750502e7873642720786d6c6e733a4853533d27687474703a2f2f7777772e6572696373736f6e2e636f6d2f50726f7072696574617279584d4c736368656d61732f776861746576657276616c696427207873693a736368656d614c6f636174696f6e3d27687474703a2f2f7777772e6572696373736f6e2e636f6d2f50726f7072696574617279584d4c736368656d61732f776861746576657276616c69642043784461746154797065457874656e73696f6e732e78736420273e3c5072697661746549443e557365724e616d65355f30406572696373736f6e2e73653c2f5072697661746549443e3c5365727669636550726f66696c653e3c5075626c69634964656e746974793e3c4964656e746974793e7369703a557365724e616d65355f305075626c6963494430406572696373736f6e2e73653c2f4964656e746974793e3c4853533a4572696373736f6e5075626c69634964656e74697479457874656e73696f6e3e3c4853533a4d61784e6f4f66436f6e74616374733e343c2f4853533a4d61784e6f4f66436f6e74616374733e3c2f4853533a4572696373736f6e5075626c69634964656e74697479457874656e73696f6e3e3c2f5075626c69634964656e746974793e3c5075626c69634964656e746974793e3c4964656e746974793e74656c3a2b3439323830303030303030353c2f4964656e746974793e3c4853533a4572696373736f6e5075626c69634964656e74697479457874656e73696f6e3e3c4853533a4d61784e6f4f66436f6e74616374733e343c2f4853533a4d61784e6f4f66436f6e74616374733e3c2f4853533a4572696373736f6e5075626c69634964656e74697479457874656e73696f6e3e3c2f5075626c69634964656e746974793e3c5075626c69634964656e746974793e3c42617272696e67496e6469636174696f6e3e313c2f42617272696e67496e6469636174696f6e3e3c4964656e746974793e7369703a323632323830303030303030303035406963732e6d6e633238302e6d63633236322e336770706e6574776f726b2e6f72673c2f4964656e746974793e3c4853533a4572696373736f6e5075626c69634964656e74697479457874656e73696f6e3e3c4853533a4d61784e6f4f66436f6e74616374733e343c2f4853533a4d61784e6f4f66436f6e74616374733e3c2f4853533a4572696373736f6e5075626c69634964656e74697479457874656e73696f6e3e3c2f5075626c69634964656e746974793e3c436f72654e6574776f726b5365727669636573417574686f72697a6174696f6e3e3c537562736372696265644d65646961")),
        ByteString(HexUtil.hexStringToByte("50726f66696c6549643e313c2f537562736372696265644d6564696150726f66696c6549643e3c2f436f72654e6574776f726b5365727669636573417574686f72697a6174696f6e3e3c496e697469616c46696c74657243726974657269613e3c5072696f726974793e3830313c2f5072696f726974793e3c54726967676572506f696e743e3c436f6e646974696f6e54797065434e463e303c2f436f6e646974696f6e54797065434e463e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c4d6574686f643e52454749535445523c2f4d6574686f643e3c457874656e73696f6e3e3c2f457874656e73696f6e3e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c53657373696f6e436173653e303c2f53657373696f6e436173653e3c2f5350543e3c2f54726967676572506f696e743e3c4170706c69636174696f6e5365727665723e3c5365727665724e616d653e7369703a6170352e6572696373736f6e2e73653b6c723b63616c6c3d6f7269673b7472616e73706f72743d7463703b6d736973646e3d3439323830303030303030353c2f5365727665724e616d653e3c2f4170706c69636174696f6e5365727665723e3c2f496e697469616c46696c74657243726974657269613e3c496e697469616c46696c74657243726974657269613e3c5072696f726974793e3830333c2f5072696f726974793e3c54726967676572506f696e743e3c436f6e646974696f6e54797065434e463e303c2f436f6e646974696f6e54797065434e463e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c4d6574686f643e5055424c4953483c2f4d6574686f643e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c5349504865616465723e3c4865616465723e4576656e743c2f4865616465723e3c436f6e74656e743e2f70726573656e63652f693c2f436f6e74656e743e3c2f5349504865616465723e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c53657373696f6e436173653e303c2f53657373696f6e436173653e3c2f5350543e3c2f54726967676572506f696e743e3c4170706c69636174696f6e5365727665723e3c5365727665724e616d653e7369703a6170352e6572696373736f6e2e73653b6c723b63616c6c3d6f7269673b7472616e73706f72743d7463703b6d736973646e3d3439323830303030303030353c2f5365727665724e616d653e3c2f4170706c69636174696f6e5365727665723e3c2f496e697469616c46696c74657243726974657269613e3c496e697469616c46696c74657243726974657269613e3c5072696f726974793e3830353c2f5072696f726974793e3c54726967676572506f696e743e3c436f6e646974696f6e54797065434e463e303c2f436f6e646974696f6e54797065434e463e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c")),
        ByteString(HexUtil.hexStringToByte("2f47726f75703e3c4d6574686f643e5355425343524942453c2f4d6574686f643e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c5349504865616465723e3c4865616465723e4576656e743c2f4865616465723e3c436f6e74656e743e2f70726573656e63652f693c2f436f6e74656e743e3c2f5349504865616465723e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c53657373696f6e436173653e313c2f53657373696f6e436173653e3c2f5350543e3c2f54726967676572506f696e743e3c4170706c69636174696f6e5365727665723e3c5365727665724e616d653e7369703a6170352e6572696373736f6e2e73653b6c723b63616c6c3d7465726d5f726567697374657265643b7472616e73706f72743d7463703b6d736973646e3d3439323830303030303030353c2f5365727665724e616d653e3c2f4170706c69636174696f6e5365727665723e3c2f496e697469616c46696c74657243726974657269613e3c496e697469616c46696c74657243726974657269613e3c5072696f726974793e3830373c2f5072696f726974793e3c54726967676572506f696e743e3c436f6e646974696f6e54797065434e463e303c2f436f6e646974696f6e54797065434e463e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c4d6574686f643e5355425343524942453c2f4d6574686f643e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c5349504865616465723e3c4865616465723e4576656e743c2f4865616465723e3c436f6e74656e743e2f70726573656e63652f693c2f436f6e74656e743e3c2f5349504865616465723e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c53657373696f6e436173653e323c2f53657373696f6e436173653e3c2f5350543e3c2f54726967676572506f696e743e3c4170706c69636174696f6e5365727665723e3c5365727665724e616d653e7369703a6170352e6572696373736f6e2e73653b6c723b63616c6c3d7465726d5f756e726567697374657265643b7472616e73706f72743d7463703b6d736973646e3d3439323830303030303030353c2f5365727665724e616d653e3c2f4170706c69636174696f6e5365727665723e3c2f496e697469616c46696c74657243726974657269613e3c496e697469616c46696c74657243726974657269613e3c5072696f726974793e3830393c2f5072696f726974793e3c54726967676572506f696e743e3c436f6e646974696f6e54797065434e463e303c2f436f6e646974696f6e54797065434e463e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c4d6574686f643e5355425343524942453c2f4d6574686f643e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465")),
        ByteString(HexUtil.hexStringToByte("643e3c47726f75703e303c2f47726f75703e3c5349504865616465723e3c4865616465723e4576656e743c2f4865616465723e3c436f6e74656e743e2f70726573656e63655c2e77696e666f2f693c2f436f6e74656e743e3c2f5349504865616465723e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c53657373696f6e436173653e303c2f53657373696f6e436173653e3c2f5350543e3c2f54726967676572506f696e743e3c4170706c69636174696f6e5365727665723e3c5365727665724e616d653e7369703a6170352e6572696373736f6e2e73653b6c723b63616c6c3d6f7269673b7472616e73706f72743d7463703b6d736973646e3d3439323830303030303030353c2f5365727665724e616d653e3c2f4170706c69636174696f6e5365727665723e3c2f496e697469616c46696c74657243726974657269613e3c496e697469616c46696c74657243726974657269613e3c5072696f726974793e3831313c2f5072696f726974793e3c54726967676572506f696e743e3c436f6e646974696f6e54797065434e463e303c2f436f6e646974696f6e54797065434e463e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c526571756573745552493e2f5e2e2a3b6c6973743d2f693c2f526571756573745552493e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c4d6574686f643e5355425343524942453c2f4d6574686f643e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c5349504865616465723e3c4865616465723e4576656e743c2f4865616465723e3c436f6e74656e743e2f70726573656e63652f693c2f436f6e74656e743e3c2f5349504865616465723e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c5349504865616465723e3c4865616465723e537570706f727465643c2f4865616465723e3c436f6e74656e743e2f6576656e746c6973742f693c2f436f6e74656e743e3c2f5349504865616465723e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c53657373696f6e436173653e303c2f53657373696f6e436173653e3c2f5350543e3c2f54726967676572506f696e743e3c4170706c69636174696f6e5365727665723e3c5365727665724e616d653e7369703a6170352e6572696373736f6e2e73653b6c723b63616c6c3d6f7269673b7472616e73706f72743d7463703b6d736973646e3d3439323830303030303030353c2f5365727665724e616d653e3c2f4170706c69636174696f6e5365727665723e3c2f496e697469616c46696c74657243726974657269613e3c496e697469616c46696c74657243726974657269613e3c5072696f726974793e3530313c2f5072696f726974793e3c54726967676572506f696e743e3c436f6e646974696f6e54797065434e463e303c")),
        ByteString(HexUtil.hexStringToByte("2f436f6e646974696f6e54797065434e463e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c4d6574686f643e5355425343524942453c2f4d6574686f643e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c5349504865616465723e3c4865616465723e4576656e743c2f4865616465723e3c436f6e74656e743e2f75612d70726f66696c652f693c2f436f6e74656e743e3c2f5349504865616465723e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c5349504865616465723e3c4865616465723e4576656e743c2f4865616465723e3c436f6e74656e743e2f70726f66696c652d747970653d6170706c69636174696f6e2f693c2f436f6e74656e743e3c2f5349504865616465723e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c5349504865616465723e3c4865616465723e4576656e743c2f4865616465723e3c436f6e74656e743e2f617569643d6f72672e6f70656e6d6f62696c65616c6c69616e63652e707265732d72756c65732f693c2f436f6e74656e743e3c2f5349504865616465723e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c53657373696f6e436173653e313c2f53657373696f6e436173653e3c2f5350543e3c2f54726967676572506f696e743e3c4170706c69636174696f6e5365727665723e3c5365727665724e616d653e7369703a70726573656e63655f61735f686f73746e616d652e6572696373736f6e2e73653b6c723b63616c6c3d7465726d5f726567697374657265643b7472616e73706f72743d7463703b6d736973646e3d3439323830303030303030353c2f5365727665724e616d653e3c2f4170706c69636174696f6e5365727665723e3c2f496e697469616c46696c74657243726974657269613e3c496e697469616c46696c74657243726974657269613e3c5072696f726974793e3530333c2f5072696f726974793e3c54726967676572506f696e743e3c436f6e646974696f6e54797065434e463e303c2f436f6e646974696f6e54797065434e463e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c4d6574686f643e5355425343524942453c2f4d6574686f643e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c5349504865616465723e3c4865616465723e4576656e743c2f4865616465723e3c436f6e74656e743e2f75612d70726f66696c652f693c2f436f6e74656e743e3c2f5349504865616465723e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c5349504865616465723e3c4865616465723e4576656e743c2f48656164")),
        ByteString(HexUtil.hexStringToByte("65723e3c436f6e74656e743e2f70726f66696c652d747970653d6170706c69636174696f6e2f693c2f436f6e74656e743e3c2f5349504865616465723e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c5349504865616465723e3c4865616465723e4576656e743c2f4865616465723e3c436f6e74656e743e2f617569643d6f72672e6f70656e6d6f62696c65616c6c69616e63652e707265732d72756c65732f693c2f436f6e74656e743e3c2f5349504865616465723e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c53657373696f6e436173653e323c2f53657373696f6e436173653e3c2f5350543e3c2f54726967676572506f696e743e3c4170706c69636174696f6e5365727665723e3c5365727665724e616d653e7369703a70726573656e63655f61735f686f73746e616d652e6572696373736f6e2e73653b6c723b63616c6c3d7465726d5f756e726567697374657265643b7472616e73706f72743d7463703b6d736973646e3d3439323830303030303030353c2f5365727665724e616d653e3c2f4170706c69636174696f6e5365727665723e3c2f496e697469616c46696c74657243726974657269613e3c496e697469616c46696c74657243726974657269613e3c5072696f726974793e3630313c2f5072696f726974793e3c54726967676572506f696e743e3c436f6e646974696f6e54797065434e463e303c2f436f6e646974696f6e54797065434e463e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c4d6574686f643e5355425343524942453c2f4d6574686f643e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c5349504865616465723e3c4865616465723e4576656e743c2f4865616465723e3c436f6e74656e743e2f75612d70726f66696c652f693c2f436f6e74656e743e3c2f5349504865616465723e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c5349504865616465723e3c4865616465723e4576656e743c2f4865616465723e3c436f6e74656e743e2f70726f66696c652d747970653d6170706c69636174696f6e2f693c2f436f6e74656e743e3c2f5349504865616465723e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c5349504865616465723e3c4865616465723e4576656e743c2f4865616465723e3c436f6e74656e743e2f617569643d726c732d73657276696365732f693c2f436f6e74656e743e3c2f5349504865616465723e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c53657373696f6e436173653e313c2f53657373696f6e436173653e3c2f5350543e3c2f54726967676572506f696e743e3c4170706c69636174696f6e5365")),
        ByteString(HexUtil.hexStringToByte("727665723e3c5365727665724e616d653e7369703a70726573656e63655f61735f686f73746e616d652e6572696373736f6e2e73653b6c723b63616c6c3d7465726d5f726567697374657265643b7472616e73706f72743d7463703b6d736973646e3d3439323830303030303030353c2f5365727665724e616d653e3c2f4170706c69636174696f6e5365727665723e3c2f496e697469616c46696c74657243726974657269613e3c496e697469616c46696c74657243726974657269613e3c5072696f726974793e3630333c2f5072696f726974793e3c54726967676572506f696e743e3c436f6e646974696f6e54797065434e463e303c2f436f6e646974696f6e54797065434e463e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c4d6574686f643e5355425343524942453c2f4d6574686f643e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c5349504865616465723e3c4865616465723e4576656e743c2f4865616465723e3c436f6e74656e743e2f75612d70726f66696c652f693c2f436f6e74656e743e3c2f5349504865616465723e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c5349504865616465723e3c4865616465723e4576656e743c2f4865616465723e3c436f6e74656e743e2f70726f66696c652d747970653d6170706c69636174696f6e2f693c2f436f6e74656e743e3c2f5349504865616465723e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c5349504865616465723e3c4865616465723e4576656e743c2f4865616465723e3c436f6e74656e743e2f617569643d726c732d73657276696365732f693c2f436f6e74656e743e3c2f5349504865616465723e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c53657373696f6e436173653e323c2f53657373696f6e436173653e3c2f5350543e3c2f54726967676572506f696e743e3c4170706c69636174696f6e5365727665723e3c5365727665724e616d653e7369703a70726573656e63655f61735f686f73746e616d652e6572696373736f6e2e73653b6c723b63616c6c3d7465726d5f756e726567697374657265643b7472616e73706f72743d7463703b6d736973646e3d3439323830303030303030353c2f5365727665724e616d653e3c2f4170706c69636174696f6e5365727665723e3c2f496e697469616c46696c74657243726974657269613e3c496e697469616c46696c74657243726974657269613e3c5072696f726974793e3730313c2f5072696f726974793e3c54726967676572506f696e743e3c436f6e646974696f6e54797065434e463e303c2f436f6e646974696f6e54797065434e463e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c4d6574686f643e5355425343524942453c2f4d6574686f643e3c2f5350543e3c")),
        ByteString(HexUtil.hexStringToByte("5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c5349504865616465723e3c4865616465723e4576656e743c2f4865616465723e3c436f6e74656e743e2f75612d70726f66696c652f693c2f436f6e74656e743e3c2f5349504865616465723e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c5349504865616465723e3c4865616465723e4576656e743c2f4865616465723e3c436f6e74656e743e2f70726f66696c652d747970653d6170706c69636174696f6e2f693c2f436f6e74656e743e3c2f5349504865616465723e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c5349504865616465723e3c4865616465723e4576656e743c2f4865616465723e3c436f6e74656e743e2f617569643d7265736f757263652d6c697374732f693c2f436f6e74656e743e3c2f5349504865616465723e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c53657373696f6e436173653e313c2f53657373696f6e436173653e3c2f5350543e3c2f54726967676572506f696e743e3c4170706c69636174696f6e5365727665723e3c5365727665724e616d653e7369703a70726573656e63655f61735f686f73746e616d652e6572696373736f6e2e73653b6c723b63616c6c3d7465726d5f726567697374657265643b7472616e73706f72743d7463703b6d736973646e3d3439323830303030303030353c2f5365727665724e616d653e3c2f4170706c69636174696f6e5365727665723e3c2f496e697469616c46696c74657243726974657269613e3c496e697469616c46696c74657243726974657269613e3c5072696f726974793e3730333c2f5072696f726974793e3c54726967676572506f696e743e3c436f6e646974696f6e54797065434e463e303c2f436f6e646974696f6e54797065434e463e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c4d6574686f643e5355425343524942453c2f4d6574686f643e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c5349504865616465723e3c4865616465723e4576656e743c2f4865616465723e3c436f6e74656e743e2f75612d70726f66696c652f693c2f436f6e74656e743e3c2f5349504865616465723e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c5349504865616465723e3c4865616465723e4576656e743c2f4865616465723e3c436f6e74656e743e2f70726f66696c652d747970653d6170706c69636174696f6e2f693c2f436f6e74656e743e3c2f5349504865616465723e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c5349")),
        ByteString(HexUtil.hexStringToByte("504865616465723e3c4865616465723e4576656e743c2f4865616465723e3c436f6e74656e743e2f617569643d7265736f757263652d6c697374732f693c2f436f6e74656e743e3c2f5349504865616465723e3c2f5350543e3c5350543e3c436f6e646974696f6e4e6567617465643e303c2f436f6e646974696f6e4e6567617465643e3c47726f75703e303c2f47726f75703e3c53657373696f6e436173653e323c2f53657373696f6e436173653e3c2f5350543e3c2f54726967676572506f696e743e3c4170706c69636174696f6e5365727665723e3c5365727665724e616d653e7369703a70726573656e63655f61735f686f73746e616d652e6572696373736f6e2e73653b6c723b63616c6c3d7465726d5f756e726567697374657265643b7472616e73706f72743d7463703b6d736973646e3d3439323830303030303030353c2f5365727665724e616d653e3c2f4170706c69636174696f6e5365727665723e3c2f496e697469616c46696c74657243726974657269613e3c457874656e73696f6e3e3c2f457874656e73696f6e3e3c4853533a4572696373736f6e5365727669636550726f66696c65457874656e73696f6e3e3c4853533a4d61784e6f53696d756c74616e656f757353657373696f6e733e31313c2f4853533a4d61784e6f53696d756c74616e656f757353657373696f6e733e3c4853533a50686f6e65436f6e746578743e2b343932383c2f4853533a50686f6e65436f6e746578743e3c2f4853533a4572696373736f6e5365727669636550726f66696c65457874656e73696f6e3e3c2f5365727669636550726f66696c653e3c5365727669636550726f66696c653e3c5075626c69634964656e746974793e3c4964656e746974793e7369703a32363232383030303030303030303540696d732e6d6e633238302e6d63633236322e336770706e6574776f726b2e6f72673c2f4964656e746974793e3c4853533a4572696373736f6e5075626c69634964656e74697479457874656e73696f6e3e3c4853533a4d61784e6f4f66436f6e74616374733e343c2f4853533a4d61784e6f4f66436f6e74616374733e3c2f4853533a4572696373736f6e5075626c69634964656e74697479457874656e73696f6e3e3c2f5075626c69634964656e746974793e3c436f72654e6574776f726b5365727669636573417574686f72697a6174696f6e3e3c537562736372696265644d6564696150726f66696c6549643e303c2f537562736372696265644d6564696150726f66696c6549643e3c2f436f72654e6574776f726b5365727669636573417574686f72697a6174696f6e3e3c457874656e73696f6e3e3c2f457874656e73696f6e3e3c4853533a4572696373736f6e5365727669636550726f66696c65457874656e73696f6e3e3c4853533a4d61784e6f53696d756c74616e656f757353657373696f6e733e303c2f4853533a4d61784e6f53696d756c74616e656f757353657373696f6e733e3c2f4853533a4572696373736f6e5365727669636550726f66696c65457874656e73696f6e3e3c2f5365727669636550726f66696c653e3c4853533a4572696373736f6e494d53537562736372697074696f6e457874656e73696f6e3e3c4853533a537562736372697074696f6e49643e3c4853533a537562736372697074696f6e4964547970653e303c2f4853533a537562736372697074696f6e4964547970653e3c4853533a537562736372697074696f6e4964446174613e343932383030303030"))
      )
      val lastFragment = ByteString(HexUtil.hexStringToByte("3030353c2f4853533a537562736372697074696f6e4964446174613e3c2f4853533a537562736372697074696f6e49643e3c2f4853533a4572696373736f6e494d53537562736372697074696f6e457874656e73696f6e3e3c2f494d53537562736372697074696f6e3e00000000026ac00000ec000028af0000026bc0000037000028af6161613a2f2f43532e65706b2e6572696373736f6e2e73653a333836373b7472616e73706f72743d746370000000026cc0000037000028af6161613a2f2f43532e65706b2e6572696373736f6e2e73653a333836373b7472616e73706f72743d746370000000026dc0000037000028af6161613a2f2f43532e65706b2e6572696373736f6e2e73653a333836373b7472616e73706f72743d746370000000026ec0000037000028af6161613a2f2f43532e65706b2e6572696373736f6e2e73653a333836373b7472616e73706f72743d74637000000000014000001f557365724e616d65355f30406572696373736f6e2e7365000000027480000038000028af0000010a4000000c000028af0000027580000010000028af000000010000027680000010000028af00000005"))

      requestFragments.foreach( f => {
        buffer ! f
      })
      expectNoMsg()
      buffer ! lastFragment
      val fragmentMsg = expectMsgAnyClassOf(classOf[DiameterMessage])
      assert(fragmentMsg.header.applicationId==16777216)
      assert(fragmentMsg.header.request ==false)
      assert(fragmentMsg.header.proxyable)
      assert(fragmentMsg.header.error == false)
      assert(fragmentMsg.header.retransmission == false)
      assert(fragmentMsg.header.commandCode == 301)
      assert( fragmentMsg.header.h2h == 0xe58881ab)
      assert( fragmentMsg.header.e2e == 0x9f80c00b)

      assert(fragmentMsg.avps.size == 10)
    }
  }
}
